$(document).ready(function(){function e(){a=new ymaps.Map("ymwap__map",{center:[o.cordinates.x,o.cordinates.y],zoom:o.zoom});var e=[];if(o.markets)for(var t=0;t<o.markets.length;t++)e[t]=new ymaps.GeoObject({geometry:{type:"Point",coordinates:[o.markets[t].posX,o.markets[t].posY]},properties:{clusterCaption:o.markets[t].hintContent,balloonContentHeader:o.markets[t].marketName,balloonContentBody:o.markets[t].marketText,balloonContentFooter:o.markets[t].marketLink}});else console.log("Маркеров на карте нет!");var i=new ymaps.Clusterer;i.add(e),a.geoObjects.add(i)}function t(){var e;void 0!=$.cookie("geoData")?(e=$.cookie("geoData"),s=e,n()):ymaps.geolocation.get({provider:"yandex"}).then(function(e){visitorLocationObject=e.geoObjects.get(0).properties.get("metaDataProperty"),i=visitorLocationObject.GeocoderMetaData.AddressDetails.Country.AddressLine,console.log(i);for(var t=0;t<cityes.length;t++){if(cityes[t]==i){s=t,$(".ymwap__popup__title span").html("<b data-city='"+cityNumber[t]+"'>"+cityes[s]+"</b>"),a.destroy();break}$(".ymwap__popup__title span").html("<b data-city='"+cityNumber[0]+"'>"+cityes[s]+"</b>")}})}var a,o,i;$.ajax({url:"map.php?action=citieslist",success:function(e){cityes=e,cityes=JSON.parse(cityes),console.log(cityes)}}),$.ajax({url:"map.php?action=citiesNumberlist",success:function(e){cityNumber=e,cityNumber=JSON.parse(cityNumber),console.log(cityNumber)}});var s=0,c={idMap:1,cordinates:{x:"55.76",y:"37.64"},zoom:10,markets:[{posX:"55.79",posY:"37.64",marketName:"Самострой",marketText:"<p style='color: red'>тел. 8 800 000 00 00<br>тел. 8 800 000 00 00</p>",marketLink:"<a href='//ya.ru' target='_blank'>test</a>"},{posX:"55.76",posY:"37.64",marketName:"Метизы",marketText:"тел. 8 800 000 00 00",marketLink:""}]};console.log(JSON.stringify(c));ymaps.ready(t);var n=function(){$(".ymwap__map-question").hide(),$(".ymwap__map-title").addClass("init"),$.ajax({url:"map.php?action=currentCity&targetCity="+s,success:function(t){o=JSON.parse(t),console.log(o),e()}})};$(document).on("click","#ymwap__yes",function(e){e.preventDefault(),s=$(".ymwap__popup__title span b").data("city"),n(),$.cookie("geoData",s)}),$(document).on("click","#ymwap__no",function(e){e.preventDefault(),$(".ymwap__popup-1").removeClass("visible"),$(".ymwap__popup-2").addClass("visible"),$(".ymwap__cities-list").html("");for(var t=0;t<cityes.length;t++)$(".ymwap__cities-list").append('<div class="ymwap__cities-list__item" data-number="'+cityNumber[t]+'">'+cityes[t]+"</div>")}),$(document).on("click",".ymwap__cities-list__item",function(e){e.preventDefault(),$(".ymwap__cities-list__item").removeClass("selected"),$(this).addClass("selected")}),$(document).on("click","#ymwap__choise-city",function(e){e.preventDefault(),$(".ymwap__cities-list__item").hasClass("selected")?(s=$(".ymwap__cities-list__item.selected").data("number"),n(),$.cookie("geoData",s)):alert("Выбири город!")})});